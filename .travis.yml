language: r
dist: trusty
os:
- linux
cache:
  directories:
  - "$HOME/.cache"
  - "$HOME/R/Library"
services:
- docker
before_install:
- openssl aes-256-cbc -K $encrypted_18ebcb932cdb_key -iv $encrypted_18ebcb932cdb_iv
  -in credentials.enc -out credentials -d
- source credentials
- source <(curl -sSL https://raw.githubusercontent.com/dynverse/travis_scripts/master/helper.sh)
install:
- set -e
- if [[ "$TRAVIS_BUILD_STAGE_NAME" != "Cache" ]]; then update_docker; fi
- install_hdf5
- install_cran remotes
- install_github_withdeps dynverse/dynutils@master dynverse/dynwrap@master dynverse/dyntoy@master
script:
- export REPO=dynverse/$NAME
- source version
- cd $NAME
- build_docker
- if [[ "$TRAVIS_BUILD_STAGE_NAME" == "Test" ]]; then test_docker; fi
- cd ..
after_success:
- export REPO=dynverse/$NAME
- push_docker
jobs:
  include:
  - stage: Cache
    install:
    - set -e
    - install_hdf5
    - install_dynverse
    - install_cran remotes
    - install_github_withdeps dynverse/dynutils@master dynverse/dynwrap@master dynverse/dyntoy@master dynverse/dyncli@master
    script:
    - echo Cache warmup
    after_success:
    - echo Cache warmup
  - stage: Base
    before_script:
    - export NAME=dynbase
  - stage: R
    before_script:
    - export NAME=dynwrapr
  - stage: Py
    before_script:
    - export NAME=dynwrappy
  - stage: Py
    before_script:
    - export NAME=dynwrappy36
  - stage: Test
    before_script:
    - export NAME=dynwrapr_tester
  - stage: Test
    before_script:
    - export NAME=dynwrappy_tester
